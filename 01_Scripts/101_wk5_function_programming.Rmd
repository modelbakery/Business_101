---
title: "101_wk5_functional_program"
author: "Seung Hyun Sung"
date: "11/10/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# DS4B 101-R: R FOR BUSINESS ANALYSIS 

# FUNCTIONAL PROGRAMMING

```{r}
library(tidyverse)
library(lubridate)
library(tidyquant)
library(ggrepel) # ggrepel needed for text and label repel in plots
library(fs)
library(kableExtra)

bike_orderlines_tbl <- read_rds("~/Desktop/University_business_science/DS4B_101/00_data/bike_sales/data_wrangled/bike_orderlines.rds")

glimpse(bike_orderlines_tbl)
```


# 1.0 ANATOMY OF A FUNCTION ----

# 1.1 Examining the mean() function ----
```{r}
x <- c(0:10, 50, NA_real_)
x
```


# 1.2 Customizing a mean function ----

```{r}
# Name                     # Arguments
mean_remove_na <- function(x, na.rm = TRUE, ...) {
    
    # Body
    avg <- mean(x, na.rm = na.rm, ...)
    
    # Return
    return(avg)
}

mean_remove_na(x)

mean_remove_na(x, na.rm = FALSE)

mean_remove_na(x, trim = 0.1)
```



# 2.0 THE TWO STYLES OF FUNCTIONS: VECTOR FUNCTIONS & DATA FUNCTIONS ----

# Calculating a 3 month rolling average  for category_1 & category_2 
# with dates aligned at last day of the month


```{r}
rolling_avg_3_tbl <- bike_orderlines_tbl %>% 
    select(order_date, category_1, category_2, total_price) %>% 
    mutate(order_date = ymd(order_date)) %>% 
    mutate(month_end = ceiling_date(order_date, unit = "month") - period(1, unit = "day")) %>% 
    group_by(category_1, category_2, month_end) %>% 
    summarise(
        total_price = sum(total_price)
    ) %>% 
    mutate(rolling_avg_3 = rollmean(total_price, k = 3, na.pad = TRUE, align = "right")) %>% 
    ungroup() %>% 
    mutate(category_2 = as_factor(category_2) %>% fct_reorder2(month_end, total_price))


rolling_avg_3_tbl %>% head(10) %>% kbl() %>% kableExtra::kable_classic()

rolling_avg_3_tbl %>% 
    ggplot(aes(x = month_end, y = total_price)) + 
    geom_point(aes(colour = category_2)) +
    geom_line(aes(y = rolling_avg_3), size =0.5) +
    facet_wrap(~category_2, scales = "free_y") +
    scale_color_tq() 

```


# Vectorized & data frame function 

Pro Tip: Vectorized functions can be used within mutate() and summarise() functions

Rule of thumb: 

* vectorized function commonly starts with x 

* data function commonly starts with data 

* Any function that get piped into dplyr operation = data frame operation 
    + group_by & mutate is data frame operation 
    + group_by(.data, ..., .add = FALSE, .drop = group_by_drop_default(.data))
    + Tidy eval operation need to be learned 

* Any function that get piped into mutate operation = vectorized operation 
    + rollmean is vectorized operation 
    + more flexible and easier to make 
    

Controlling Flow: 

* Great for checking user input to functions

* Great for Descriptive Messages, Warnings, & Errors


# 2.1 Vector Functions ----
```{r}
?ymd
?ceiling_date
?sum
?rollmean
```


# 2.2 Data Functions ----
```{r}
?select
?mutate
?group_by
?ggplot
```


# 3.0 CONTROLLING FLOW: IF STATEMENTS, MESSAGES, WARNINGS, STOP ----

* Warning: Allows function to continue 

* Errors(Stop): Does not allow function to continue 

```{r}
class_detect <- function(x){
    if(is.numeric(x)){
        message("Value is numeric")
        print(x)
    } else if(is.character(x)){
        warning("In class detect(): Value is character! Should be numeric, but can be accepted", call. = FALSE)
        print(x)
    } else if(is.logical(x)){
        stop("In class_detect(): Vlaue is logical!!! Should be numeric. Definitely cannot be accepted", call. = FALSE)
        print(x)
    } else {
        message("Unknow Class")
        print(x)
    }
}

1 %>% class_detect
"a" %>% class_detect
formula(y ~ x) %>% class_detect()
```


# 4.0 VECTORIZED REMOVE OUTLIERS FUNCTION ----
#  - Box Plot Diagram to Identify Outliers
#  - Goal: Use box plot approach to identify outliers

# Make bikes_tbl
```{r}
bikes_tbl <- bike_orderlines_tbl %>% 
    distinct(model, category_1, price)
```

# Visualize Box Plot
```{r}
bikes_tbl %>% 
    ggplot(aes(x = category_1, y = price)) +
    geom_boxplot() 
```

# Create remove_outliers()
```{r}
# NA_real_: class numeric NA 
x <- c(0:10, 50, NA_real_)
x 

detect_outliers <- function(x){
    if(missing(x)) stop("The argument x needs a vector.")
    if(!is.numeric(x)) stop("The argument x must be numeric.")
    
    data_tbl <- tibble(data = x)
    limits_tbl <- data_tbl %>% 
        summarise(
            quantile_lo = quantile(data, probs = 0.25, na.rm = TRUE),
            quantile_hi = quantile(data, probs = 0.75, na.rm = TRUE),
            iqr = IQR(data, na.rm = TRUE),
            limit_lo = quantile_lo - 1.5*iqr,
            limit_hi = quantile_hi + 1.5*iqr
        )
    output_tbl <- data_tbl %>% 
        mutate(outlier = case_when(
            data < limits_tbl$limit_lo ~ TRUE,
            data > limits_tbl$limit_hi ~ TRUE,
            TRUE ~ FALSE
        ))
    return(output_tbl$outlier)
}

detect_outliers(x)

tibble(x = x) %>% 
    mutate(outlier = detect_outliers(x))
```



# Apply remove_outliers() to bikes_tbl
```{r}
bike_outliers_tbl <- bikes_tbl %>% 
    group_by(category_1) %>% 
    mutate(outlier = detect_outliers(price)) %>% 
    ungroup()

bike_outliers_tbl %>% head(10) %>% kbl() %>% kable_classic()
```

# Visualize with remove_outlers()

geom_text_repel adds text directly to the plot. geom_label_repel draws a rectangle underneath the text, making it easier to read. The text labels repel away from each other and away from the data points.
```{r}
bike_outliers_tbl %>% 
    ggplot(aes(category_1, price)) +
    geom_boxplot() +
    ggrepel::geom_label_repel(aes(label = model),
                              color = "red",
                              data = . %>% 
                                  filter(outlier)) 
    
```


# 5.0 DATA FUNCTION: FEATURE ENGINEERING ----

- Goal: Want to simplify the text feature engineering steps to convert model name to features


Pipeline Comes From 02_data_wrangling/04_text.R

```{r}
bikes_tbl %>%
    
    select(model) %>%
    
    # Fix typo
    mutate(model = case_when(
        model == "CAAD Disc Ultegra" ~ "CAAD12 Disc Ultegra",
        model == "Syapse Carbon Tiagra" ~ "Synapse Carbon Tiagra",
        model == "Supersix Evo Hi-Mod Utegra" ~ "Supersix Evo Hi-Mod Ultegra",
        TRUE ~ model
    )) %>%
    
    # separate using spaces
    separate(col     = model, 
             into    = str_c("model_", 1:7), 
             sep     = " ", 
             remove  = FALSE, 
             fill    = "right") %>%
    
    # creating a "base" feature
    mutate(model_base = case_when(
        
        # Fix Supersix Evo
        str_detect(str_to_lower(model_1), "supersix") ~ str_c(model_1, model_2, sep = " "),
        
        # Fix Fat CAAD bikes
        str_detect(str_to_lower(model_1), "fat") ~ str_c(model_1, model_2, sep = " "),
        
        # Fix Beast of the East
        str_detect(str_to_lower(model_1), "beast") ~ str_c(model_1, model_2, model_3, model_4, sep = " "),
        
        # Fix Bad Habit
        str_detect(str_to_lower(model_1), "bad") ~ str_c(model_1, model_2, sep = " "),
        
        # Fix Scalpel 29
        str_detect(str_to_lower(model_2), "29") ~ str_c(model_1, model_2, sep = " "),
        
        # catch all
        TRUE ~ model_1)
    ) %>%
    
    # Get "tier" feature
    mutate(model_tier = model %>% str_replace(model_base, replacement = "") %>% str_trim()) %>%
    
    # Remove unnecessary columns
    select(-matches("[0-9]")) %>%
    
    # Create Flags
    mutate(
        black     = model_tier %>% str_to_lower() %>% str_detect("black") %>% as.numeric(),
        hi_mod    = model_tier %>% str_to_lower() %>% str_detect("hi-mod") %>% as.numeric(),
        team      = model_tier %>% str_to_lower() %>% str_detect("team") %>% as.numeric(),
        red       = model_tier %>% str_to_lower() %>% str_detect("red") %>% as.numeric(),
        ultegra   = model_tier %>% str_to_lower() %>% str_detect("ultegra") %>% as.numeric(),
        dura_ace  = model_tier %>% str_to_lower() %>% str_detect("dura ace") %>% as.numeric(),
        disc      = model_tier %>% str_to_lower() %>% str_detect("disc") %>% as.numeric()
    )
```

```{r}
data <- bikes_tbl 

separate_bike_model <- function(data, keep_model_column = TRUE, append = TRUE){
    
    # Append argument 
    if(!append){
        data <- data %>% select(model)
    }
    # pipline
    output_tbl <- data %>%
    
    #select(model) %>%
    
    # Fix typo
    mutate(model = case_when(
        model == "CAAD Disc Ultegra" ~ "CAAD12 Disc Ultegra",
        model == "Syapse Carbon Tiagra" ~ "Synapse Carbon Tiagra",
        model == "Supersix Evo Hi-Mod Utegra" ~ "Supersix Evo Hi-Mod Ultegra",
        TRUE ~ model
    )) %>%
    
    # separate using spaces
    separate(col     = model, 
             into    = str_c("model_", 1:7), 
             sep     = " ", 
             remove  = FALSE, 
             fill    = "right") %>%
    
    # creating a "base" feature
    mutate(model_base = case_when(
        # Fix Supersix Evo
        str_detect(str_to_lower(model_1), "supersix") ~ str_c(model_1, model_2, sep = " "),
        # Fix Fat CAAD bikes
        str_detect(str_to_lower(model_1), "fat") ~ str_c(model_1, model_2, sep = " "),
        # Fix Beast of the East
        str_detect(str_to_lower(model_1), "beast") ~ str_c(model_1, model_2, model_3, model_4, sep = " "),
        # Fix Bad Habit
        str_detect(str_to_lower(model_1), "bad") ~ str_c(model_1, model_2, sep = " "),
        # Fix Scalpel 29
        str_detect(str_to_lower(model_2), "29") ~ str_c(model_1, model_2, sep = " "),
        # catch all
        TRUE ~ model_1)
    ) %>%
    # Get "tier" feature
    mutate(model_tier = model %>% str_replace(model_base, replacement = "") %>% str_trim()) %>%
    # Remove unnecessary columns
    select(-matches("model_[0-9]")) %>%
    # Create Flags
    mutate(
        black     = model_tier %>% str_to_lower() %>% str_detect("black") %>% as.numeric(),
        hi_mod    = model_tier %>% str_to_lower() %>% str_detect("hi-mod") %>% as.numeric(),
        team      = model_tier %>% str_to_lower() %>% str_detect("team") %>% as.numeric(),
        red       = model_tier %>% str_to_lower() %>% str_detect("red") %>% as.numeric(),
        ultegra   = model_tier %>% str_to_lower() %>% str_detect("ultegra") %>% as.numeric(),
        dura_ace  = model_tier %>% str_to_lower() %>% str_detect("dura ace") %>% as.numeric(),
        disc      = model_tier %>% str_to_lower() %>% str_detect("disc") %>% as.numeric()
    )
    
    if(!keep_model_column) output_tbl <- output_tbl %>% select(-model)
    
    return(output_tbl)
}

bikes_tbl %>% separate_bike_model() %>% head(10) %>% kbl() %>% kable_classic()
bikes_tbl %>% separate_bike_model(keep_model_column = FALSE)  %>% head(10) %>% kbl() %>% kable_classic()
bikes_tbl %>% separate_bike_model(keep_model_column = FALSE, append = FALSE)  %>% head(10) %>% kbl() %>% kable_classic()
```


# 6.0 SAVING AND SOURCING FUNCTIONS ----

# 6.1 Create folder and file ----
```{r}
fs::dir_create("00")

path <- "01_Scripts/separate_bikes_and_outlier_detection.R"
fs::file_create(path)
```

# 6.2 Build and add header ----
```{r}
file_header_text <- str_glue(
"
# SEPARATE BIKE MODELS AND DETECT OUTLIERS ----
    
# separate_bikes_models(): A tidy function to separate the model column into engineered features 

# detect_outliers(): A vectorized function that detects outliers using TRUE/FALSE output

# Libraries ----
library(tidyverse)


"
)

write_lines(file_header_text, path)
```


# 6.3 Add functions with dump() ----

```{r}

c("separate_bike_model", "detect_outliers") %>% 
    dump(file = "01_Scripts/separate_bikes_and_outlier_detection.R",
         append = TRUE)
```



# 6.4 Source function ----

```{r}
rm("separate_bike_model")

source("01_Scripts/separate_bikes_and_outlier_detection.R")
```

